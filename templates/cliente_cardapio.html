{% extends 'layout.html' %}
{% block title %}CardÃ¡pio Online{% endblock %}
{% block content %}
<div id="mainPage">
    <h2 class="page-title">Nosso CardÃ¡pio</h2>
    <div class="categories-grid" id="categoriesGrid">
        {% for categoria in categorias %}
        <div class="category-card" onclick="scrollToCategory('cat-{{ categoria.id }}')">
            {% if 'http' in categoria.imagem_url %}
                <img src="{{ categoria.imagem_url }}" alt="{{ categoria.nome }}" class="category-image">
            {% else %}
                <img src="{{ url_for('uploaded_file', filename=categoria.imagem_url) }}" alt="{{ categoria.nome }}" class="category-image">
            {% endif %}
            <div class="category-info">
                <h3 class="category-title">{{ categoria.nome }}</h3>
                <p class="category-description">{{ categoria.descricao }}</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div class="products-page" id="productsPage" style="display:block; margin-top: 3rem;">
    {% for categoria in categorias %}
    <div id="cat-{{ categoria.id }}">
        <h2 class="page-title" style="margin-bottom: 1rem;">{{ categoria.nome }}</h2>
        <div class="products-grid">
            {% set produtos_ativos = categoria.produtos|selectattr('ativo', 'equalto', true)|list %}
            {% if produtos_ativos %}
                {% for produto in produtos_ativos %}
                <div class="product-card">
                    {% if produto.imagem_url %}
                    <img src="{{ url_for('uploaded_file', filename=produto.imagem_url) }}" alt="{{ produto.nome }}" class="product-image">
                    {% else %}
                    <div class="product-image placeholder-image">Sem imagem</div>
                    {% endif %}
                    <div class="product-info">
                        <h3 class="product-title">{{ produto.nome }}</h3>
                        <p class="product-description">{{ produto.descricao }}</p>
                        <div class="product-price">R$ {{ "%.2f"|format(produto.preco)|replace('.', ',') }}</div>
                        <button class="add-to-cart" onclick="addToCart('{{ produto.nome }}', {{ produto.preco }})">Adicionar</button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <p>Em breve, novos produtos nesta categoria!</p>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<div id="cart-fab" style="position: fixed; bottom: 20px; right: 20px; background: #be0404; color: white; width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3); cursor: pointer; display: none;">
    ðŸ›’
</div>

<div id="cart-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1002;">
    <div style="background: white; padding: 2rem; border-radius: 15px; width: 90%; max-width: 500px;">
        <h2>Meu Pedido</h2>
        <ul id="cart-items" style="list-style: none; padding: 0;"></ul>
        <hr style="margin: 1rem 0;">

        <div id="delivery-options">
            <h4>Escolha uma opÃ§Ã£o:</h4>
            <div style="margin-top: 0.5rem;">
                <input type="radio" id="delivery-in-city" name="deliveryOption" value="5.00" data-label="Delivery dentro da cidade">
                <label for="delivery-in-city">Delivery dentro da cidade (+ R$ 5,00)</label>
            </div>
            <div style="margin-top: 0.5rem;">
                <input type="radio" id="delivery-out-city" name="deliveryOption" value="0.00" data-label="Delivery fora da cidade">
                <label for="delivery-out-city">Delivery fora da cidade (a consultar)</label>
            </div>
            <div style="margin-top: 0.5rem;">
                <input type="radio" id="pickup" name="deliveryOption" value="0.00" data-label="Retirada">
                <label for="pickup">Retirada no local</label>
            </div>
        </div>
        <h3 id="cart-total" style="margin-top: 1rem;"></h3>
        <button class="btn" onclick="sendToWhatsapp()">Enviar Pedido via WhatsApp</button>
        <button class="back-button" onclick="closeCartModal()" style="background: #666; margin-top: 1rem;">Fechar</button>
    </div>
</div>


<script>
let cart = {};

function scrollToCategory(catId) {
    document.getElementById(catId).scrollIntoView({ behavior: 'smooth' });
}

function addToCart(name, price) {
    if (cart[name]) {
        cart[name].quantity++;
    } else {
        cart[name] = { price: price, quantity: 1 };
    }
    updateCart();
    flashMessage(`'${name}' adicionado ao carrinho!`);
}

function updateCart() {
    const cartItems = document.getElementById('cart-items');
    const cartFab = document.getElementById('cart-fab');
    cartItems.innerHTML = '';
    let itemsTotal = 0;

    if (Object.keys(cart).length > 0) {
        cartFab.style.display = 'flex';
    } else {
        cartFab.style.display = 'none';
        closeCartModal();
        return;
    }

    for (const name in cart) {
        const item = cart[name];
        itemsTotal += item.price * item.quantity;
        const li = document.createElement('li');
        li.textContent = `${item.quantity}x ${name} - R$ ${(item.price * item.quantity).toFixed(2).replace('.', ',')}`;
        li.style.padding = '0.5rem 0';
        li.style.borderBottom = '1px solid #eee';
        cartItems.appendChild(li);
    }
    
    // Calcula a taxa de entrega
    const deliveryOption = document.querySelector('input[name="deliveryOption"]:checked');
    const deliveryFee = deliveryOption ? parseFloat(deliveryOption.value) : 0;
    
    const finalTotal = itemsTotal + deliveryFee;

    // Monta o texto do total
    let totalText = `Subtotal: R$ ${itemsTotal.toFixed(2).replace('.', ',')}`;
    if (deliveryFee > 0) {
        totalText += ` + Entrega: R$ ${deliveryFee.toFixed(2).replace('.', ',')}`;
    }
    totalText += ` | Total: R$ ${finalTotal.toFixed(2).replace('.', ',')}`;
    
    document.getElementById('cart-total').textContent = totalText;
}

function sendToWhatsapp() {
    // 1. ValidaÃ§Ã£o: Verifica se uma opÃ§Ã£o foi selecionada
    const deliveryOption = document.querySelector('input[name="deliveryOption"]:checked');
    if (!deliveryOption) {
        alert("Por favor, selecione uma opÃ§Ã£o de entrega ou retirada.");
        return; // Para a execuÃ§Ã£o da funÃ§Ã£o
    }

    let message = "OlÃ¡, DogÃ£o do Alex! Gostaria de fazer o seguinte pedido:\n\n";
    let itemsTotal = 0;
    for (const name in cart) {
        const item = cart[name];
        message += `*${item.quantity}x* - ${name}\n`;
        itemsTotal += item.price * item.quantity;
    }
    
    const deliveryFee = parseFloat(deliveryOption.value);
    const finalTotal = itemsTotal + deliveryFee;
    const deliveryLabel = deliveryOption.getAttribute('data-label');

    message += `\n*Tipo de Entrega:* ${deliveryLabel}\n`;
    if (deliveryFee > 0) {
        message += `*Taxa de Entrega:* R$ ${deliveryFee.toFixed(2).replace('.', ',')}\n`;
    }
    message += `\n*Total do Pedido:* R$ ${finalTotal.toFixed(2).replace('.', ',')}`;

    const whatsappUrl = `https://wa.me/{{ whatsapp_number }}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
    
    // 2. Mensagem de confirmaÃ§Ã£o para o cliente
    alert("aguarde que em no maximo 10 minutos entraremos em contato para confirmar o pedido");

    // 3. Limpa o carrinho e fecha o modal
    cart = {};
    document.querySelector('input[name="deliveryOption"]:checked').checked = false; // Desmarca a opÃ§Ã£o
    updateCart();
}

function flashMessage(message) {
    const div = document.createElement('div');
    div.textContent = message;
    div.style.position = 'fixed';
    div.style.bottom = '90px';
    div.style.left = '50%';
    div.style.transform = 'translateX(-50%)';
    div.style.background = '#333';
    div.style.color = 'white';
    div.style.padding = '10px 20px';
    div.style.borderRadius = '20px';
    div.style.zIndex = '1001';
    document.body.appendChild(div);
    setTimeout(() => {
        div.remove();
    }, 2500);
}

document.getElementById('cart-fab').addEventListener('click', () => {
    document.getElementById('cart-modal').style.display = 'flex';
    updateCart(); // Atualiza o carrinho ao abrir
});

function closeCartModal() {
    document.getElementById('cart-modal').style.display = 'none';
}

// Adiciona um listener para recalcular o total sempre que uma opÃ§Ã£o de entrega for alterada
document.querySelectorAll('input[name="deliveryOption"]').forEach(radio => {
    radio.addEventListener('change', updateCart);
});
</script>
{% endblock %}